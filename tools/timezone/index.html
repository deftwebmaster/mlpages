<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Zone Overlap Finder</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      background: #f5f5f5;
    }

    header {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    button {
      background: #007aff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    button:hover { background: #005ecb; }

    section {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 { font-size: 1.2rem; margin-bottom: 1rem; color: #333; }

    /* Person row */
    .person-row {
      display: grid;
      grid-template-columns: 150px 200px 120px 120px auto;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
      padding: 0.75rem;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .person-row input, .person-row select {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .person-row button {
      background: #ff3b30;
      padding: 0.5rem;
    }

    /* Timeline */
    #timeline-container { 
      margin-top: 1rem;
      position: relative;
      padding-left: 180px;
    }

    .timeline-header {
      position: relative;
      height: 30px;
      background: #f0f0f0;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    .timeline-tick {
      position: absolute;
      top: 0;
      font-size: 0.7rem;
      color: #666;
      transform: translateX(-50%);
    }

    .timeline-row {
      position: relative;
      height: 32px;
      background: #fafafa;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      border: 1px solid #e0e0e0;
    }

    .timeline-label {
      position: absolute;
      left: -170px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: #555;
      width: 160px;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .timeline-bar {
      position: absolute;
      height: 100%;
      background: #007aff;
      opacity: 0.6;
      border-radius: 3px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .timeline-bar:hover { 
      opacity: 0.9;
    }

    .timeline-bar.overlap {
      background: #34c759;
      opacity: 0.8;
      height: 40px;
      top: -4px;
    }

    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 1000;
      white-space: nowrap;
    }

    /* Suggestions */
    .suggestion-item {
      padding: 0.75rem;
      background: #f0f9ff;
      border-left: 3px solid #007aff;
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }

    .no-overlap {
      background: #fff3cd;
      border-left-color: #ffc107;
    }

    @media (max-width: 768px) {
      body { padding: 1rem; }
      
      .person-row {
        grid-template-columns: 1fr;
      }
      
      #timeline-container {
        padding-left: 0;
      }
      
      .timeline-label {
        position: static;
        transform: none;
        text-align: left;
        margin-bottom: 0.25rem;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Time Zone Overlap Finder</h1>
    <div class="controls">
      <label>
        <input type="checkbox" id="toggle24h" checked> 24-hour time
      </label>
      <button id="shareBtn">üìã Copy share link</button>
    </div>
  </header>

  <main>
    <section id="people-section">
      <h2>People & Working Hours</h2>
      <div id="people-list"></div>
      <button id="addPersonBtn">+ Add person</button>
    </section>

    <section id="timeline-section">
      <h2>Timeline (UTC reference)</h2>
      <div id="timeline-container"></div>
    </section>

    <section id="suggestions-section">
      <h2>Best Meeting Times</h2>
      <div id="suggestions"></div>
    </section>
  </main>

  <script>
    const { DateTime } = luxon;

    // State
    const state = {
      use24h: true,
      anchorDate: DateTime.now().plus({ days: 1 }).startOf('day'), // Tomorrow
      people: []
    };

    // Common time zones (top 20)
    const commonZones = [
      'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
      'America/Toronto', 'America/Mexico_City', 'America/Sao_Paulo',
      'Europe/London', 'Europe/Paris', 'Europe/Berlin', 'Europe/Amsterdam',
      'Asia/Tokyo', 'Asia/Shanghai', 'Asia/Singapore', 'Asia/Dubai', 'Asia/Kolkata',
      'Australia/Sydney', 'Pacific/Auckland',
      'UTC'
    ];

    let nextId = 1;

    // Initialize
    function init() {
      loadFromURL();
      if (state.people.length === 0) {
        const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        addPerson('You', userTz, 9*60, 17*60);
      }
      
      document.getElementById('toggle24h').addEventListener('change', (e) => {
        state.use24h = e.target.checked;
        render();
      });
      
      document.getElementById('addPersonBtn').addEventListener('click', () => {
        addPerson('', 'UTC', 9*60, 17*60);
        render();
      });
      
      document.getElementById('shareBtn').addEventListener('click', copyShareLink);
      
      render();
    }

    function addPerson(name, tz, startMin, endMin) {
      state.people.push({
        id: `p${nextId++}`,
        name: name || `Person ${state.people.length + 1}`,
        tz,
        startMin,
        endMin
      });
    }

    function removePerson(id) {
      state.people = state.people.filter(p => p.id !== id);
      render();
    }

    // Render
    function render() {
      renderPeopleList();
      renderTimeline();
      renderSuggestions();
    }

    function renderPeopleList() {
      const container = document.getElementById('people-list');
      container.innerHTML = state.people.map(person => `
        <div class="person-row" data-id="${person.id}">
          <input type="text" value="${person.name}" placeholder="Name" 
                 onchange="updatePerson('${person.id}', 'name', this.value)">
          <select onchange="updatePerson('${person.id}', 'tz', this.value)">
            ${commonZones.map(tz => `
              <option value="${tz}" ${tz === person.tz ? 'selected' : ''}>${tz.replace(/_/g, ' ')}</option>
            `).join('')}
          </select>
          <input type="time" value="${minToTime(person.startMin)}" 
                 onchange="updatePerson('${person.id}', 'startMin', timeToMin(this.value))">
          <input type="time" value="${minToTime(person.endMin)}" 
                 onchange="updatePerson('${person.id}', 'endMin', timeToMin(this.value))">
          <button onclick="removePerson('${person.id}')">Remove</button>
        </div>
      `).join('');
    }

    function renderTimeline() {
      const container = document.getElementById('timeline-container');
      
      // Header ticks (UTC hours)
      let headerHTML = '<div class="timeline-header">';
      for (let h = 0; h <= 24; h += 3) {
        headerHTML += `<div class="timeline-tick" style="left: ${h/24*100}%">${String(h).padStart(2, '0')}:00</div>`;
      }
      headerHTML += '</div>';
      
      // Person rows
      let rowsHTML = '';
      state.people.forEach(person => {
        const intervals = localToUTCIntervals(person);
        rowsHTML += `<div class="timeline-row">`;
        rowsHTML += `<div class="timeline-label">${person.name} (${person.tz.split('/').pop().replace(/_/g, ' ')})</div>`;
        intervals.forEach(([start, end]) => {
          const left = (start / 1440) * 100;
          const width = ((end - start) / 1440) * 100;
          const localStart = formatTime(person.startMin);
          const localEnd = formatTime(person.endMin);
          rowsHTML += `<div class="timeline-bar" 
                           style="left: ${left}%; width: ${width}%"
                           title="${localStart} - ${localEnd} (${person.name})"></div>`;
        });
        rowsHTML += '</div>';
      });
      
      // Overlap row
      const overlap = computeOverlap();
      if (overlap.length > 0) {
        rowsHTML += `<div class="timeline-row">`;
        rowsHTML += `<div class="timeline-label"><strong>‚≠ê Overlap</strong></div>`;
        overlap.forEach(([start, end]) => {
          const left = (start / 1440) * 100;
          const width = ((end - start) / 1440) * 100;
          const durationMin = end - start;
          const durationHr = Math.floor(durationMin / 60);
          const durationRemainder = durationMin % 60;
          const durationStr = durationHr > 0 
            ? `${durationHr}h ${durationRemainder}m` 
            : `${durationRemainder}m`;
          rowsHTML += `<div class="timeline-bar overlap" 
                           style="left: ${left}%; width: ${width}%"
                           title="Overlap: ${durationStr}"></div>`;
        });
        rowsHTML += '</div>';
      }
      
      container.innerHTML = headerHTML + rowsHTML;
    }

    function renderSuggestions() {
      const container = document.getElementById('suggestions');
      const overlap = computeOverlap();
      
      if (overlap.length === 0) {
        container.innerHTML = '<div class="suggestion-item no-overlap">‚ö†Ô∏è No overlap found. Consider async communication or flexible hours.</div>';
        return;
      }
      
      // Sort by duration
      const sorted = overlap.sort((a, b) => (b[1] - b[0]) - (a[1] - a[0]));
      
      let html = '';
      sorted.slice(0, 3).forEach(([start, end], i) => {
        const mid = Math.floor((start + end) / 2);
        const midRounded = Math.round(mid / 15) * 15; // Round to 15min
        
        const times = state.people.map(p => {
          const localTime = utcToLocal(midRounded, p.tz);
          return `<strong>${formatTime(localTime)}</strong> ${p.name}`;
        }).join(' ‚Ä¢ ');
        
        const durationMin = end - start;
        const durationHr = Math.floor(durationMin / 60);
        const durationRemainder = durationMin % 60;
        const durationStr = durationHr > 0 
          ? `${durationHr}h ${durationRemainder}m window` 
          : `${durationRemainder}m window`;
        
        html += `<div class="suggestion-item">
          <div><strong>Option ${i + 1}:</strong> ${times}</div>
          <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">${durationStr}</div>
        </div>`;
      });
      
      container.innerHTML = html;
    }

    // Time conversion
    function localToUTCIntervals(person) {
      const { tz, startMin, endMin } = person;
      
      try {
        const base = state.anchorDate.setZone(tz);
        
        const startDT = base.set({ hour: Math.floor(startMin / 60), minute: startMin % 60 });
        const endDT = base.set({ hour: Math.floor(endMin / 60), minute: endMin % 60 });
        
        const startUTC = startDT.toUTC().diff(state.anchorDate.toUTC(), 'minutes').minutes;
        let endUTC = endDT.toUTC().diff(state.anchorDate.toUTC(), 'minutes').minutes;
        
        // Handle midnight wrap
        if (endMin <= startMin) {
          endUTC += 1440;
        }
        
        // Normalize to 0-1440 range
        const intervals = [];
        if (startUTC < 0) {
          intervals.push([startUTC + 1440, 1440]);
          if (endUTC > 0) intervals.push([0, Math.min(endUTC, 1440)]);
        } else if (endUTC > 1440) {
          intervals.push([startUTC, 1440]);
          intervals.push([0, endUTC - 1440]);
        } else {
          intervals.push([startUTC, endUTC]);
        }
        
        return intervals;
      } catch (e) {
        console.error('Error converting time for', person, e);
        return [];
      }
    }

    function utcToLocal(utcMin, tz) {
      try {
        const dt = state.anchorDate.toUTC().plus({ minutes: utcMin }).setZone(tz);
        return dt.hour * 60 + dt.minute;
      } catch (e) {
        console.error('Error converting UTC to local', e);
        return 0;
      }
    }

    function computeOverlap() {
      if (state.people.length === 0) return [];
      
      let intervals = [[0, 1440]];
      
      state.people.forEach(person => {
        const personIntervals = localToUTCIntervals(person);
        intervals = intersectIntervals(intervals, personIntervals);
      });
      
      return intervals.filter(([start, end]) => end > start);
    }

    function intersectIntervals(a, b) {
      const result = [];
      for (const [a1, a2] of a) {
        for (const [b1, b2] of b) {
          const start = Math.max(a1, b1);
          const end = Math.min(a2, b2);
          if (start < end) result.push([start, end]);
        }
      }
      return result;
    }

    // Utilities
    function updatePerson(id, field, value) {
      const person = state.people.find(p => p.id === id);
      if (person) {
        person[field] = value;
        render();
      }
    }

    function minToTime(min) {
      const h = Math.floor(min / 60);
      const m = min % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    function timeToMin(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    }

    function formatTime(min) {
      const h = Math.floor(min / 60);
      const m = min % 60;
      if (state.use24h) {
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      }
      const period = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:${String(m).padStart(2, '0')} ${period}`;
    }

    // Share link
    function copyShareLink() {
      const params = state.people.map(p => 
        `${encodeURIComponent(p.name)},${p.tz},${p.startMin},${p.endMin}`
      ).join(';');
      
      const url = `${window.location.origin}${window.location.pathname}?p=${params}`;
      navigator.clipboard.writeText(url).then(() => {
        const btn = document.getElementById('shareBtn');
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        setTimeout(() => btn.textContent = originalText, 2000);
      });
    }

    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      const pData = params.get('p');
      
      if (pData) {
        const people = pData.split(';').map(entry => {
          const [name, tz, start, end] = entry.split(',');
          return {
            id: `p${nextId++}`,
            name: decodeURIComponent(name),
            tz,
            startMin: parseInt(start),
            endMin: parseInt(end)
          };
        });
        state.people = people;
      }
    }

    // Expose to window for inline handlers
    window.updatePerson = updatePerson;
    window.removePerson = removePerson;

    init();
  </script>
</body>
</html>